"""
This module stored pre-configred SQL statements
"""
# backend/app/dao/{{ table_singular_snakecase_name}}.py
import math
{% if db_type == "postgresql" %}
import psycopg2.extras.DictCursor
{% endif %}

from ..database import get_connection

{{ table_singular_snakecase_name | upper }}_SELECT_ALL = """SELECT 
{% for col in columns %}
{{col.name}}{% if not loop.last %},{% endif %}
{% endfor %}

FROM 
{% if table.schema %}{{table.schema}}.{% endif %}{{table.name}}
"""

{{ table_singular_snakecase_name | upper }}_SELECT_BY_KEY = """SELECT 
{% for col in columns %}
{{col.name}}{% if not loop.last %},{% endif %}
{% endfor %}

FROM {% if table.schema %}{{table.schema}}.{% endif %}{{table.name}} a
{% if pk_columns %} WHERE
{% else %}
--No primary key defined, please add WHERE clause here
{% endif %}
{% for pk_col in pk_columns %}a.{{pk_col.name }}=%({{pk_col.name }})s{% if not loop.last %} AND {% endif %}
{% endfor %}
"""

{{ table_singular_snakecase_name | upper }}_RECORD_COUNT = """SELECT count(*)
FROM {% if table.schema %}{{table.schema}}.{% endif %}{{table.name}} 
"""


{{ table_singular_snakecase_name | upper }}_INSERT = """INSERT INTO  {% if table.schema %}{{table.schema}}.{% endif -%}{{table.name}}
({% for col in columns %}{{col.name}}{% if not loop.last %},{% endif %}{% endfor %}) VALUES
({% for col in columns %}
%({{col.name}})s{% if not loop.last %},
{% endif %}
{% endfor %})
{% if pk_columns %}
{% if is_postgresql %} 
ON CONFLICT ({% for pk_col in pk_columns %}{{pk_col.name }}{% if not loop.last %}, {% endif %}{% endfor %})
DO UPDATE SET
{% for col in non_pk_columns %}{{col.name}}=excluded.{{col.name}}{% if not loop.last %},
{% endif %}
{% endfor %}

{% endif %}
{% endif %}
RETURNING *
"""

{{ table_singular_snakecase_name | upper }}_UPDATE = """UPDATE  {% if table.schema %}{{table.schema}}.{% endif -%}{{table.name}}
SET {% for col in non_pk_columns %}{{col.name}}=%({{col.name}})s{% if not loop.last %},
{% endif %}
{% endfor %}

{% if pk_columns %} WHERE
{% else %}
--No primary key defined, please add WHERE clause here
{% endif %}
{% for pk_col in pk_columns %}{{pk_col.name }}=%({{pk_col.name }})s{% if not loop.last %} AND {% endif %}
{% endfor %}
"""

{{ table_singular_snakecase_name | upper }}_DELETE = """DELETE FROM  {% if table.schema %}{{table.schema}}.{% endif -%}{{table.name}}
{% if pk_columns %} WHERE
{% else %}
--No primary key defined, please add WHERE clause here
{% endif %}
{% for pk_col in pk_columns %}{{pk_col.name }}=%({{pk_col.name }})s{% if not loop.last %} AND {% endif %}
{% endfor %}
RETURNING *
"""

def create_{{ table_singular_snakecase_name}}(request_json:dict):
    with get_connection() as conn:
        {% if db_type == "postgresql" %}
        cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
        {% elif db_type == "mysql" %}
        cursor = conn.cursor(dictionary=True)
        {% else %}
        cursor = conn.cursor()
        {% endif %}      

        cursor.execute({{ table_singular_snakecase_name | upper }}_INSERT, request_json)
        data = cursor.fetchone()
        cursor.close()
    return data


def read_{{ table_singular_snakecase_name}}(request_json:dict):
    with get_connection() as conn:
        {% if db_type == "postgresql" %}
        cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
        {% elif db_type == "mysql" %}
        cursor = conn.cursor(dictionary=True)
        {% else %}
        cursor = conn.cursor()
        {% endif %}    

        cursor.execute({{ table_singular_snakecase_name | upper }}_SELECT_BY_KEY, request_json)
        data = cursor.fetchone()
        cursor.close()
    return data


def read_all_{{ table_singular_snakecase_name}}(request_json: dict, page_number: int = None, page_size: int = None):
    """Please change ORDER BY according to you table data and display requirement"""
    with get_connection() as conn:
        total_items = 0
        offset = 0
        limit = 0
        total_pages = 0
        if page_number is not None and page_size is not None:
            cursor = conn.cursor()
            cursor.execute({{ table_singular_snakecase_name | upper }}_RECORD_COUNT)
            total_items = cursor.fetchone()[0]
            offset = (page_number - 1) * page_size
            limit = page_size
            total_pages = math.ceil(total_items / page_size)
            cursor.close()
        
        {% if db_type == "postgresql" %}
        cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
        {% elif db_type == "mysql" %}
        cursor = conn.cursor(dictionary=True)
        {% else %}
        cursor = conn.cursor()
        {% endif %}   
        if page_size is not None and total_items>page_size:
            PAGE_CLAUSE = f"ORDER BY 1 LIMIT {limit} OFFSET {offset}"
        else:
            PAGE_CLAUSE = ""

        cursor.execute({{ table_singular_snakecase_name | upper }}_SELECT_ALL + PAGE_CLAUSE, request_json)
        data = cursor.fetchall()
        cursor.close()

    return data

def update_{{ table_singular_snakecase_name}}(request_json:dict):
    with get_connection() as conn:        
        cursor = conn.cursor()        
        cursor.execute({{ table_singular_snakecase_name | upper }}_UPDATE, request_json)        
        cursor.close()
    return request_json



def delete_{{ table_singular_snakecase_name}}(request_json:dict):
    with get_connection() as conn:
        {% if db_type == "postgresql" %}
        cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
        {% elif db_type == "mysql" %}
        cursor = conn.cursor(dictionary=True)
        {% else %}
        cursor = conn.cursor()
        {% endif %}    
        cursor.execute({{ table_singular_snakecase_name | upper }}_DELETE, request_json)
        data = cursor.fetchone()
        cursor.close()
    return data




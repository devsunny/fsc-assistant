<template>
  <div class="{{ table_snake_case }}-view">
    <Toast />
    <ConfirmDialog></ConfirmDialog>
    <h1>Manage {{ table_plural_pascal }}</h1>

    <Button label="Add New {{ table_singular_pascal }}" icon="pi pi-plus" @click="startCreate" class="p-button-primary" />

    <Dialog v-model:visible="displayDialog" :header="editing{{ table_singular_pascal }} && editing{{ table_singular_pascal }}.{{ pk_name | snake_case }} ? 'Edit {{ table_singular_pascal }}' : 'Create {{ table_singular_pascal }}'" :modal="true" :style="{width: '50vw'}">
      <{{ table_singular_pascal }}Component
        :{{ table_snake_case }}="editing{{ table_singular_pascal }}"
        @{{ table_snake_case }}Created="handle{{ table_singular_pascal }}Created"
        @{{ table_snake_case }}Updated="handle{{ table_singular_pascal }}Updated"
        @cancelEdit="cancelEdit"
      />
    </Dialog>

    <h2>{{ table_plural_pascal }} List</h2>
    <DataTable :value="{{ '{{' }} {{ table_plural_snake }} {{ '}}' }}" responsiveLayout="scroll">
      <Column field="{{ pk_name | snake_case }}" header="ID"></Column>
      {% for column in columns %}
      {% if not column.is_primary %}
      <Column field="{{ column.name | snake_case }}" header="{{ column.name | pascal_case }}"></Column>
      {% endif %}
      {% endfor %}

      {% if is_root_table %}
      {% for child_table in child_tables %}
      <Column header="{{ child_table.name | pluralize | pascal_case }}">
        <template #body="slotProps">
          <ul v-if="slotProps.data.{{ child_table.name | pluralize | snake_case }}_collection && slotProps.data.{{ child_table.name | pluralize | snake_case }}_collection.length">
            <li v-for="child in slotProps.data.{{ child_table.name | pluralize | snake_case }}_collection" :key="child.{{ child_table | get_pk_name | snake_case }}">
              {{ child_table.name | singularize | pascal_case }} ID: {{ '{{' }} child.{{ child_table | get_pk_name | snake_case }} {{ '}}' }}
              {% for child_column in child_table.columns.values() %}
              {% if not child_column.is_primary %}
              , {{ child_column.name | snake_case }}: {{ '{{' }} child.{{ child_column.name | snake_case }} {{ '}}' }}
              {% endif %}
              {% endfor %}
            </li>
          </ul>
          <span v-else>No {{ child_table.name | pluralize | pascal_case }}</span>
        </template>
      </Column>
      {% endfor %}
      {% endif %}

      <Column header="Actions">
        <template #body="slotProps">
          <Button icon="pi pi-pencil" class="p-button-rounded p-button-success p-mr-2" @click="startEdit(slotProps.data)" />
          <Button icon="pi pi-trash" class="p-button-rounded p-button-danger" @click="confirmDelete(slotProps.data.{{ pk_name | snake_case }})" />
        </template>
      </Column>
    </DataTable>
  </div>
</template>

<script>
import axios from 'axios';
import {{ table_singular_pascal }}Component from '@/components/{{ table_singular_pascal }}.vue';
// PrimeVue components imported globally in main.js

export default {
  name: '{{ table_plural_pascal }}View',
  components: {
    {{ table_singular_pascal }}Component,
  },
  data() {
    return {
      {{ table_plural_snake }}: [],
      editing{{ table_singular_pascal }}: null,
      displayDialog: false,
      backendUrl: import.meta.env.VITE_APP_BACKEND_API_URL || '{{ backend_api_url }}'
    };
  },
  created() {
    this.fetch{{ table_plural_pascal }}();
  },
  methods: {
    async fetch{{ table_plural_pascal }}() {
      try {
        let url = `${this.backendUrl}/{{ table_plural_snake }}`;
        // If this is a root table, request eager loading of relationships
        if (this.isRootTable) {
          url += '?eager_load_relations=true';
        }
        const response = await axios.get(url);
        this.{{ table_plural_snake }} = response.data;
      } catch (error) {
        console.error("Error fetching {{ table_plural_snake }}:", error);
        this.$toast.add({severity:'error', summary: 'Error', detail:'Failed to fetch {{ table_plural_snake }}. Check console.', life: 3000});
      }
    },
    startCreate() {
      this.editing{{ table_singular_pascal }} = {
        {% for column in columns %}
        {% if not column.is_primary %}
        {{ column.name | snake_case }}: {{ column | get_default_value_for_type }},
        {% endif %}
        {% endfor %}
      };
      this.displayDialog = true;
    },
    startEdit({{ table_snake_case }}ToEdit) {
      this.editing{{ table_singular_pascal }} = { ...{{ table_snake_case }}ToEdit };
      this.displayDialog = true;
    },
    cancelEdit() {
      this.editing{{ table_singular_pascal }} = null;
      this.displayDialog = false;
    },
    handle{{ table_singular_pascal }}Created(new{{ table_singular_pascal }}) {
      // Refresh the list to ensure relationships are correctly fetched if needed
      this.displayDialog = false;
      this.fetch{{ table_plural_pascal }}();
      this.$toast.add({severity:'success', summary: 'Success', detail:'{{ table_singular_pascal }} Created', life: 3000});
    },
    handle{{ table_singular_pascal }}Updated(updated{{ table_singular_pascal }}) {
      // Refresh the list to ensure relationships are correctly fetched if needed
      this.displayDialog = false;
      this.fetch{{ table_plural_pascal }}();
      this.$toast.add({severity:'success', summary: 'Success', detail:'{{ table_singular_pascal }} Updated', life: 3000});
    },
    confirmDelete({{ pk_name | snake_case }}) {
      this.$confirm.require({
        message: 'Are you sure you want to delete this item?',
        header: 'Confirmation',
        icon: 'pi pi-exclamation-triangle',
        accept: () => {
          this.delete{{ table_singular_pascal }}({{ pk_name | snake_case }});
        },
        reject: () => {
          this.$toast.add({severity:'info', summary:'Cancelled', detail:'Delete operation cancelled', life: 3000});
        }
      });
    },
    async delete{{ table_singular_pascal }}(idToDelete) { // Renamed parameter to avoid conflict
      try {
        await axios.delete(`${this.backendUrl}/{{ table_plural_snake }}/` + idToDelete);
        this.{{ table_plural_snake }} = this.{{ table_plural_snake }}.filter(item => item.{{ pk_name | snake_case }} !== idToDelete);
        this.$toast.add({severity:'success', summary: 'Success', detail:'{{ table_singular_pascal }} Deleted', life: 3000});
      } catch (error) {
        console.error("Error deleting {{ table_snake_case }}:", error);
        this.$toast.add({severity:'error', summary: 'Error', detail:'Failed to delete {{ table_snake_case }}. Check console.', life: 3000});
      }
    }
  },
  computed: {
    isRootTable() {
      // Determine if the current view's table is specified as a root table
      // This is a simplified check. For more robust solution, pass this from generator.
      const currentPath = this.$route.path;
      const currentTableSlug = currentPath.split('/').pop(); // e.g., 'users' from '/users'
      // Compare with the plural snake case of the table name
      return currentTableSlug === '{{ table_plural_snake }}' && {{ 'true' if table.name in root_table_names else 'false' }};
    }
  }
};
</script>

<style scoped>
.{{ table_snake_case }}-view {
  max-width: 1200px; /* Wider for DataTable */
  margin: 20px auto;
  padding: 20px;
  background-color: var(--surface-card);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
}

h1, h2 {
  color: var(--text-color);
  text-align: center;
  margin-bottom: 20px;
}

.p-button {
  margin-bottom: 20px;
}

/* Styles for DataTable and its elements can be further customized */
.p-datatable .p-datatable-tbody > tr > td {
  text-align: left;
}

.actions .p-button {
  margin-left: 0.5rem;
}
</style>
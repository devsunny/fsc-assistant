<template>
  <div class="{{ table_snake_case }}-item">
    <h3>{{ table_singular_pascal }} Details</h3>
    <form @submit.prevent="save{{ table_singular_pascal }}">
      {% for column in columns %}
      {% if not column.is_primary %}
      <div class="p-field">
        <label for="{{ column.name | snake_case }}">{{ column.name | pascal_case }}:</label>
        {% if column.data_type == 'boolean' %}
        <Checkbox v-model="editable{{ table_singular_pascal }}.{{ column.name | snake_case }}" :binary="true" />
        {% else %}
        <InputText id="{{ column.name | snake_case }}" v-model="editable{{ table_singular_pascal }}.{{ column.name | snake_case }}" {% if not column.nullable %}required{% endif %} />
        {% endif %}
      </div>
      {% endif %}
      {% endfor %}
      <Button type="submit" :label="editable{{ table_singular_pascal }}.{{ pk_name | snake_case }} ? 'Update' : 'Create'" icon="pi pi-save" class="p-button-success" />
      <Button type="button" label="Cancel" icon="pi pi-times" class="p-button-secondary" @click="cancelEdit" />
    </form>
  </div>
</template>

<script>
import axios from 'axios';
// PrimeVue components are globally registered in main.js, no need to import here
// import InputText from 'primevue/inputtext';
// import Button from 'primevue/button';
// import Checkbox from 'primevue/checkbox';

export default {
  name: '{{ table_singular_pascal }}Component',
  props: {
    {{ table_snake_case }}: {
      type: Object,
      default: () => ({
        {% for column in columns %}
        {% if not column.is_primary %}
        {{ column.name | snake_case }}: {{ column | get_default_value_for_type }},
        {% endif %}
        {% endfor %}
      })
    }
  },
  data() {
    return {
      editable{{ table_singular_pascal }}: { ...this.{{ table_snake_case }} },
      backendUrl: import.meta.env.VITE_APP_BACKEND_API_URL || '{{ backend_api_url }}'
    };
  },
  watch: {
    {{ table_snake_case }}: {
      handler(newVal) {
        this.editable{{ table_singular_pascal }} = { ...newVal };
      },
      deep: true,
      immediate: true
    }
  },
  methods: {
    async save{{ table_singular_pascal }}() {
      try {
        let response;
        if (this.editable{{ table_singular_pascal }}.{{ pk_name | snake_case }}) {
          // Update existing
          const response = await axios.put(
            `${this.backendUrl}/{{ table_plural_snake }}/${this.editable{{ table_singular_pascal }}.{{ pk_name | snake_case }}}`,
            this.editable{{ table_singular_pascal }}
          );
          this.$toast.add({severity:'success', summary: 'Success', detail:'{{ table_singular_pascal }} Updated', life: 3000});
          this.$emit('{{ table_snake_case }}Updated', response.data);
        } else {
          // Create new
          const response = await axios.post(
            `${this.backendUrl}/{{ table_plural_snake }}`,
            this.editable{{ table_singular_pascal }}
          );
          this.$toast.add({severity:'success', summary: 'Success', detail:'{{ table_singular_pascal }} Created', life: 3000});
          this.$emit('{{ table_snake_case }}Created', response.data);
        }
        this.resetForm();
      } catch (error) {
        console.error("Error saving {{ table_snake_case }}:", error);
        this.$toast.add({severity:'error', summary: 'Error', detail:'Failed to save {{ table_snake_case }}. Check console.', life: 3000});
      }
    },
    resetForm() {
      this.editable{{ table_singular_pascal }} = {
        {% for column in columns %}
        {% if not column.is_primary %}
        {{ column.name | snake_case }}: {{ column | get_default_value_for_type }},
        {% endif %}
        {% endfor %}
      };
    },
    cancelEdit() {
      this.$emit('cancelEdit');
    }
  }
};
</script>

<style scoped>
/* PrimeVue will handle most styling, but custom adjustments can go here */
.{{ table_snake_case }}-item {
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
  background-color: var(--surface-card); /* Using PrimeVue CSS variables */
}

.p-field {
  margin-bottom: 1rem;
}

.p-field label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: bold;
}

.p-button {
  margin-right: 0.5rem;
}
</style>